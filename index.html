<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Neon Edge Studio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    :root {
      --bg: #111;
      --panel: #181818;
      --accent: #ff4500;
      --accent-soft: #ff7a3c;
      --text: #f5f5f5;
      --muted: #888;
      --danger: #ff4b6a;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #222 0, #111 45%, #000 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding-bottom: env(safe-area-inset-bottom);
      padding-top: env(safe-area-inset-top);
    }

    .app {
      max-width: 1100px;
      width: 100%;
      margin: 0 auto;
      padding: 12px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    header {
      text-align: center;
      margin-bottom: 2px;
    }

    header h1 {
      margin: 0;
      font-size: clamp(1.3rem, 4vw, 1.6rem);
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--accent-soft);
      text-shadow: 0 0 8px rgba(255, 69, 0, 0.7);
    }

    header p {
      margin: 4px 0 0;
      color: var(--muted);
      font-size: clamp(0.75rem, 3vw, 0.9rem);
    }

    .contenido {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    @media (min-width: 900px) {
      .contenido {
        flex-direction: row;
      }
    }

    .panel {
      background: rgba(20, 20, 20, 0.95);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      box-shadow:
        0 0 20px rgba(0, 0, 0, 0.8),
        0 0 25px rgba(255, 69, 0, 0.1);
      padding: 14px 16px 16px;
    }

    .panel-canvas {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 260px;
    }

    .panel-controles {
      flex: 0 0 310px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    @media (max-width: 600px) {
      .panel-canvas {
        min-height: 280px;
      }
    }

    h2 {
      margin: 0 0 4px;
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #eee;
    }

    .subtitulo {
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .input-archivo-wrapper {
      border-radius: 10px;
      border: 1px dashed rgba(255, 255, 255, 0.25);
      background: linear-gradient(135deg, #181818, #111);
      padding: 14px;
      text-align: center;
      position: relative;
      cursor: pointer;
      transition: border-color 0.2s, box-shadow 0.2s, transform 0.15s;
    }

    .input-archivo-wrapper:hover,
    .input-archivo-wrapper.dragover,
    .input-archivo-wrapper:focus-within {
      border-color: var(--accent);
      box-shadow: 0 0 18px rgba(255, 69, 0, 0.5);
      transform: translateY(-1px);
    }

    .input-archivo-wrapper input[type="file"] {
      opacity: 0;
      position: absolute;
      inset: 0;
      cursor: pointer;
    }

    .input-archivo-texto-principal {
      font-size: 0.95rem;
      margin-bottom: 4px;
    }

    .input-archivo-texto-secundario {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .controles-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .control {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.8rem;
    }

    .control label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      color: #ddd;
    }

    .control label span.valor {
      color: var(--accent-soft);
      font-variant-numeric: tabular-nums;
      font-size: 0.78rem;
    }

    input[type="range"] {
      width: 100%;
      -webkit-appearance: none;
      appearance: none;
      height: 4px;
      border-radius: 999px;
      background: linear-gradient(90deg, #333, #222);
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 10px rgba(255, 69, 0, 0.8);
      cursor: pointer;
      border: 1px solid #fff;
    }

    input[type="range"]::-moz-range-thumb {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 10px rgba(255, 69, 0, 0.8);
      cursor: pointer;
      border: 1px solid #fff;
    }

    input[type="color"] {
      width: 100%;
      height: 32px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: #111;
      padding: 0;
      cursor: pointer;
    }

    .botones {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    button {
      flex: 1 1 auto;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      padding: 8px 12px;
      background: radial-gradient(circle at top, #252525, #141414);
      color: var(--text);
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      cursor: pointer;
      transition: box-shadow 0.2s, transform 0.15s, border-color 0.2s, background 0.2s;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
    }

    button.primary {
      border-color: rgba(255, 69, 0, 0.7);
      background: radial-gradient(circle at top, #33140a, #140705);
      box-shadow: 0 0 16px rgba(255, 69, 0, 0.5);
    }

    button.secondary {
      border-color: rgba(255, 255, 255, 0.18);
    }

    button.danger {
      border-color: rgba(255, 75, 106, 0.8);
      background: radial-gradient(circle at top, #33101a, #140509);
    }

    button:hover,
    button:focus-visible {
      box-shadow:
        0 0 12px rgba(255, 69, 0, 0.6),
        0 0 20px rgba(255, 255, 255, 0.08);
      transform: translateY(-1px);
    }

    button:disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .fila-botones-extra {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 2px;
    }

    .fila-botones-extra label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.78rem;
      color: var(--muted);
      cursor: pointer;
      user-select: none;
    }

    .fila-botones-extra input[type="checkbox"] {
      accent-color: var(--accent);
      width: 16px;
      height: 16px;
    }

    .canvas-wrapper {
      flex: 1;
      background: #000;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      box-shadow:
        0 0 25px rgba(0, 0, 0, 0.9),
        0 0 40px rgba(255, 69, 0, 0.4);
      position: relative;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    @media (max-width: 600px) {
      .canvas-wrapper {
        height: 280px;
      }
    }

    canvas {
      max-width: 100%;
      max-height: 100%;
      background: #000;
      display: block;
    }

    .estado {
      font-size: 0.8rem;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .estado span.fichero {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 60%;
    }

    .spinner-overlay {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at center, rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.88));
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      gap: 10px;
      z-index: 10;
    }

    .spinner-overlay.visible {
      display: flex;
    }

    .spinner {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      border: 3px solid rgba(255, 69, 0, 0.2);
      border-top-color: var(--accent);
      animation: girar 0.8s linear infinite;
      box-shadow: 0 0 18px rgba(255, 69, 0, 0.9);
    }

    @keyframes girar {
      to {
        transform: rotate(360deg);
      }
    }

    footer {
      text-align: center;
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="app" aria-label="Editor efecto neon">
    <header>
      <h1>Neon Edge Studio</h1>
      <p>Sube selfie o foto completa Â· Funciona perfecto en iPhone Â· Procesado 100% local</p>
    </header>

    <main class="contenido">
      <section class="panel panel-canvas" aria-label="Vista previa">
        <h2>Vista previa</h2>
        <p class="subtitulo">Mezcla entre foto original y contorno neon brillante sobre fondo negro.</p>
        <div class="canvas-wrapper">
          <canvas id="canvas" aria-label="Lienzo de efecto neon"></canvas>

          <div class="spinner-overlay" id="spinner">
            <div class="spinner" aria-hidden="true"></div>
            <div style="font-size:0.85rem;color:#eee;">Procesando efecto neon...</div>
          </div>
        </div>
      </section>

      <section class="panel panel-controles" aria-label="Panel de control">
        <div>
          <h2>ðŸ“± Cargar foto</h2>
          <p class="subtitulo">iPhone: cÃ¡mara o fototeca Â· Se redimensiona automÃ¡ticamente.</p>
          <div class="input-archivo-wrapper" id="zona-soltar" aria-label="Zona de carga de imagen" tabindex="0">
            <div class="input-archivo-texto-principal">Haz clic o arrastra</div>
            <div class="input-archivo-texto-secundario">JPG, PNG, HEIC</div>
            <input id="archivo" type="file" accept="image/*" aria-label="Seleccionar foto de galerÃ­a o cÃ¡mara" />
          </div>
        </div>

        <div>
          <h2>Ajustes neon</h2>
          <div class="controles-grid" aria-label="Controles del efecto">
            <div class="control">
              <label for="umbral">
                Umbral bordes
                <span class="valor" id="valor-umbral">75</span>
              </label>
              <input id="umbral" type="range" min="20" max="150" value="75" />
            </div>

            <div class="control">
              <label for="glow">
                Brillo glow
                <span class="valor" id="valor-glow">22</span>
              </label>
              <input id="glow" type="range" min="5" max="50" value="22" />
            </div>

            <div class="control">
              <label for="grosor">
                Grosor lÃ­nea
                <span class="valor" id="valor-grosor">1.8</span>
              </label>
              <input id="grosor" type="range" min="1" max="5" step="0.5" value="1.8" />
            </div>

            <div class="control">
              <label for="nitidez">
                Nitidez
                <span class="valor" id="valor-nitidez">25</span>
              </label>
              <input id="nitidez" type="range" min="-50" max="100" value="25" />
            </div>

            <div class="control">
              <label for="mezcla">
                Foto original
                <span class="valor" id="valor-mezcla">30%</span>
              </label>
              <input id="mezcla" type="range" min="0" max="100" value="30" />
            </div>

            <div class="control">
              <label for="color">
                Color neon
                <span class="valor" id="valor-color">#ff4500</span>
              </label>
              <input id="color" type="color" value="#ff4500" />
            </div>
          </div>

          <div class="fila-botones-extra">
            <label for="invertir">
              <input id="invertir" type="checkbox" />
              Negativo
            </label>
            <label for="suavizar">
              <input id="suavizar" type="checkbox" checked />
              Menos ruido
            </label>
          </div>
        </div>

        <div>
          <h2>âš¡ Acciones</h2>
          <div class="botones" aria-label="Botones de acciones">
            <button id="btn-aplicar" class="primary" disabled>ðŸ”¥ Aplicar neon</button>
            <button id="btn-reset" class="secondary" disabled>â†» Reset</button>
            <button id="btn-descargar" class="secondary" disabled>ðŸ’¾ Descargar PNG</button>
          </div>
          <div class="estado" aria-live="polite">
            <span id="estado-texto">Toca para cargar foto</span>
            <span class="fichero" id="estado-archivo"></span>
          </div>
        </div>
      </section>
    </main>

    <footer>
      Optimizado para iPhone Â· PrÃ³ximos: presets, WebGL, mÃ¡s efectos Â· v2.1
    </footer>
  </div>

  <script>
    // Optimizado para iOS Safari + mejoras de rendimiento
    const inputArchivo = document.getElementById("archivo");
    const zonaSoltar = document.getElementById("zona-soltar");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d", { willReadFrequently: true, alpha: true });

    const sliderUmbral = document.getElementById("umbral");
    const sliderGlow = document.getElementById("glow");
    const sliderGrosor = document.getElementById("grosor");
    const sliderNitidez = document.getElementById("nitidez");
    const sliderMezcla = document.getElementById("mezcla");
    const inputColor = document.getElementById("color");
    const chkInvertir = document.getElementById("invertir");
    const chkSuavizar = document.getElementById("suavizar");

    const valorUmbral = document.getElementById("valor-umbral");
    const valorGlow = document.getElementById("valor-glow");
    const valorGrosor = document.getElementById("valor-grosor");
    const valorNitidez = document.getElementById("valor-nitidez");
    const valorMezcla = document.getElementById("valor-mezcla");
    const valorColor = document.getElementById("valor-color");

    const btnAplicar = document.getElementById("btn-aplicar");
    const btnReset = document.getElementById("btn-reset");
    const btnDescargar = document.getElementById("btn-descargar");

    const textoEstado = document.getElementById("estado-texto");
    const textoArchivo = document.getElementById("estado-archivo");
    const spinner = document.getElementById("spinner");

    let imagenOriginal = null;
    let anchoOriginal = 0;
    let altoOriginal = 0;

    const canvasOculto = document.createElement("canvas");
    const ctxOculto = canvasOculto.getContext("2d", { willReadFrequently: true });
    const canvasEdges = document.createElement("canvas");
    const ctxEdges = canvasEdges.getContext("2d", { willReadFrequently: true });

    let timeoutProcesar = null;
    let esMovil = /iPhone|iPad|iPod/.test(navigator.userAgent);

    function mostrarSpinner(mostrar) {
      spinner.classList.toggle("visible", mostrar);
    }

    function actualizarEtiquetas() {
      valorUmbral.textContent = sliderUmbral.value;
      valorGlow.textContent = sliderGlow.value;
      valorGrosor.textContent = sliderGrosor.value;
      valorNitidez.textContent = sliderNitidez.value;
      valorMezcla.textContent = sliderMezcla.value + "%";
      valorColor.textContent = inputColor.value;
    }

    function limitarResolucion(ancho, alto, max = esMovil ? 1400 : 2000) {
      if (ancho <= max && alto <= max) return { ancho, alto };
      const ratio = ancho / alto;
      if (ratio >= 1) {
        return { ancho: max, alto: Math.round(max / ratio) };
      } else {
        return { ancho: Math.round(max * ratio), alto: max };
      }
    }

    function clonarDatosImagen(imageData) {
      return new ImageData(
        new Uint8ClampedArray(imageData.data),
        imageData.width,
        imageData.height
      );
    }

    function cargarImagen(archivo) {
      if (!archivo || !archivo.type.startsWith("image/")) {
        textoEstado.textContent = "Selecciona una imagen vÃ¡lida.";
        return;
      }
      const lector = new FileReader();
      lector.onload = function (e) {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = function () {
          const dims = limitarResolucion(img.naturalWidth, img.naturalHeight);
          anchoOriginal = dims.ancho;
          altoOriginal = dims.alto;

          canvas.width = anchoOriginal;
          canvas.height = altoOriginal;

          canvasOculto.width = anchoOriginal;
          canvasOculto.height = altoOriginal;
          canvasEdges.width = anchoOriginal;
          canvasEdges.height = altoOriginal;

          ctxOculto.imageSmoothingEnabled = true;
          ctxOculto.clearRect(0, 0, anchoOriginal, altoOriginal);
          ctxOculto.drawImage(img, 0, 0, anchoOriginal, altoOriginal);

          imagenOriginal = img;

          ctx.imageSmoothingEnabled = true;
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0, anchoOriginal, altoOriginal);

          textoEstado.textContent = "Foto cargada âœ“ Ajusta y aplica el efecto neon.";
          textoArchivo.textContent = archivo.name;

          btnAplicar.disabled = false;
          btnReset.disabled = false;
          btnDescargar.disabled = false;

          procesarConDebounce();
        };
        img.src = e.target.result;
      };
      lector.readAsDataURL(archivo);
    }

    function aplicarEfectoNeon() {
      if (!imagenOriginal) return;
      mostrarSpinner(true);

      requestAnimationFrame(() => {
        const baseData = ctxOculto.getImageData(0, 0, anchoOriginal, altoOriginal);

        let procesada = baseData;
        if (chkSuavizar.checked) {
          procesada = aplicarSuavizadoGaussiano(procesada, esMovil ? 1 : 1);
        }

        const grisData = convertirAGris(procesada);

        const nitidezFactor = parseInt(sliderNitidez.value, 10);
        let afterNitidez = grisData;
        if (nitidezFactor !== 0) {
          afterNitidez = ajustarNitidez(grisData, nitidezFactor);
        }

        const umbral = parseInt(sliderUmbral.value, 10);
        const edgesData = detectarBordesSobel(afterNitidez, umbral);

        dibujarGlow(edgesData);

        mezclarOriginalEfecto();

        mostrarSpinner(false);
      });
    }

    function procesarConDebounce() {
      if (!imagenOriginal) return;
      clearTimeout(timeoutProcesar);
      timeoutProcesar = setTimeout(aplicarEfectoNeon, esMovil ? 250 : 180);
    }

    function convertirAGris(imageData) {
      const data = imageData.data;
      const out = clonarDatosImagen(imageData);
      const o = out.data;
      for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        const gris = 0.299 * r + 0.587 * g + 0.114 * b;
        o[i] = o[i + 1] = o[i + 2] = gris;
        o[i + 3] = 255;
      }
      return out;
    }

    function aplicarSuavizadoGaussiano(imageData, repeticiones = 1) {
      const kernel = [1, 2, 1, 2, 4, 2, 1, 2, 1];
      const factor = 16;
      let resultado = imageData;
      for (let r = 0; r < repeticiones; r++) {
        resultado = aplicarConvolucionGris(resultado, kernel, factor, 0);
      }
      return resultado;
    }

    function aplicarConvolucionGris(imageData, kernel, factor, offset) {
      const { width, height, data } = imageData;
      const out = new ImageData(width, height);
      const dst = out.data;
      const k = kernel;
      for (let y = 1; y < height - 1; y++) {
        for (let x = 1; x < width - 1; x++) {
          let sum = 0;
          let idx = (y * width + x) * 4;
          const posiciones = [
            idx - 4 - width * 4, idx - width * 4, idx + 4 - width * 4,
            idx - 4, idx, idx + 4,
            idx - 4 + width * 4, idx + width * 4, idx + 4 + width * 4
          ];
          for (let i = 0; i < 9; i++) {
            const di = posiciones[i];
            sum += data[di] * k[i];
          }
          let g = sum / factor + offset;
          g = g < 0 ? 0 : g > 255 ? 255 : g;
          dst[idx] = dst[idx + 1] = dst[idx + 2] = g;
          dst[idx + 3] = 255;
        }
      }
      return out;
    }

    function ajustarNitidez(imageData, factorNitidez) {
      const blurred = aplicarSuavizadoGaussiano(imageData, 1);
      const { width, height, data } = imageData;
      const sharp = clonarDatosImagen(imageData);
      const sd = sharp.data;
      const bd = blurred.data;
      let amount = factorNitidez >= 0 ? factorNitidez / 65 : factorNitidez / 70;
      for (let i = 0; i < data.length; i += 4) {
        const orig = data[i];
        const blur = bd[i];
        let val = orig + amount * (orig - blur);
        val = val < 0 ? 0 : val > 255 ? 255 : val;
        sd[i] = sd[i + 1] = sd[i + 2] = val;
        sd[i + 3] = 255;
      }
      return sharp;
    }

    function detectarBordesSobel(imageData, umbral) {
      const { width, height, data } = imageData;
      const Gx = [-1, 0, 1, -2, 0, 2, -1, 0, 1];
      const Gy = [-1, -2, -1, 0, 0, 0, 1, 2, 1];
      const out = new ImageData(width, height);
      const dst = out.data;
      for (let y = 1; y < height - 1; y++) {
        for (let x = 1; x < width - 1; x++) {
          let idx = (y * width + x) * 4;
          const posiciones = [
            idx - 4 - width * 4, idx - width * 4, idx + 4 - width * 4,
            idx - 4, idx, idx + 4,
            idx - 4 + width * 4, idx + width * 4, idx + 4 + width * 4
          ];
          let sumX = 0;
          let sumY = 0;
          for (let i = 0; i < 9; i++) {
            const p = data[posiciones[i]];
            sumX += p * Gx[i];
            sumY += p * Gy[i];
          }
          const mag = Math.sqrt(sumX * sumX + sumY * sumY);
          const v = mag > umbral ? 255 : 0;
          dst[idx] = dst[idx + 1] = dst[idx + 2] = v;
          dst[idx + 3] = v;
        }
      }
      return out;
    }

    function dibujarGlow(edgesData) {
      const { width, height, data } = edgesData;
      canvasEdges.width = width;
      canvasEdges.height = height;

      ctxEdges.globalCompositeOperation = "source-over";
      ctxEdges.clearRect(0, 0, width, height);
      ctxEdges.fillStyle = "#000";
      ctxEdges.fillRect(0, 0, width, height);

      const color = inputColor.value;
      const grosor = parseFloat(sliderGrosor.value);

      ctxEdges.lineCap = "round";
      ctxEdges.lineJoin = "round";
      ctxEdges.globalCompositeOperation = "lighter";

      const pasosGlow = esMovil ? 2 : 3;
      const blurBase = parseInt(sliderGlow.value, 10);

      for (let pass = pasosGlow; pass >= 1; pass--) {
        ctxEdges.save();
        ctxEdges.lineWidth = grosor + pass * 0.9;
        ctxEdges.strokeStyle = color;
        ctxEdges.shadowColor = color;
        ctxEdges.shadowBlur = (blurBase * pass) / 2;
        ctxEdges.beginPath();
        for (let y = 0; y < height; y++) {
          for (let x = 0; x < width; x++) {
            const idx = (y * width + x) * 4;
            const v = data[idx];
            if (v > 0) {
              ctxEdges.moveTo(x, y);
              ctxEdges.lineTo(x + 0.1, y + 0.1);
            }
          }
        }
        ctxEdges.stroke();
        ctxEdges.restore();
      }

      if (chkInvertir.checked) {
        const tmp = ctxEdges.getImageData(0, 0, width, height);
        const td = tmp.data;
        for (let i = 0; i < td.length; i += 4) {
          td[i] = 255 - td[i];
          td[i + 1] = 255 - td[i + 1];
          td[i + 2] = 255 - td[i + 2];
        }
        ctxEdges.putImageData(tmp, 0, 0);
      }
    }

    function mezclarOriginalEfecto() {
      if (!imagenOriginal) return;
      const mezcla = parseInt(sliderMezcla.value, 10) / 100;

      ctx.setTransform(1, 0, 0, 1, 0, 0);
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      ctx.fillStyle = "#000";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      if (mezcla > 0) {
        ctx.globalAlpha = mezcla;
        ctx.globalCompositeOperation = "source-over";
        ctx.drawImage(imagenOriginal, 0, 0, anchoOriginal, altoOriginal);
      }

      ctx.globalAlpha = 1;
      ctx.globalCompositeOperation = "lighter";
      ctx.drawImage(canvasEdges, 0, 0);

      ctx.globalCompositeOperation = "source-over";
      ctx.globalAlpha = 1;
    }

    // Eventos optimizados
    function manejarArchivoSeleccionado(e) {
      const archivo = e.target.files[0];
      if (!archivo) return;
      cargarImagen(archivo);
    }

    inputArchivo.addEventListener("change", manejarArchivoSeleccionado);

    zonaSoltar.addEventListener("dragover", (e) => {
      e.preventDefault();
      zonaSoltar.classList.add("dragover");
    });

    zonaSoltar.addEventListener("dragleave", (e) => {
      e.preventDefault();
      zonaSoltar.classList.remove("dragover");
    });

    zonaSoltar.addEventListener("drop", (e) => {
      e.preventDefault();
      zonaSoltar.classList.remove("dragover");
      const archivo = e.dataTransfer.files[0];
      if (archivo) {
        inputArchivo.files = e.dataTransfer.files;
        cargarImagen(archivo);
      }
    });

    zonaSoltar.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        inputArchivo.click();
      }
    });

    [
      sliderUmbral, sliderGlow, sliderGrosor, sliderNitidez, sliderMezcla, inputColor, chkInvertir, chkSuavizar
    ].forEach((el) => {
      el.addEventListener("input", () => {
        actualizarEtiquetas();
        procesarConDebounce();
      });
    });

    btnAplicar.addEventListener("click", aplicarEfectoNeon);

    btnReset.addEventListener("click", () => {
      if (!imagenOriginal) return;
      sliderUmbral.value = 75;
      sliderGlow.value = 22;
      sliderGrosor.value = 1.8;
      sliderNitidez.value = 25;
      sliderMezcla.value = 30;
      inputColor.value = "#ff4500";
      chkInvertir.checked = false;
      chkSuavizar.checked = true;
      actualizarEtiquetas();
      procesarConDebounce();
    });

    btnDescargar.addEventListener("click", () => {
      if (!imagenOriginal) return;
      try {
        canvas.toBlob((blob) => {
          const enlace = document.createElement("a");
          enlace.href = URL.createObjectURL(blob);
          enlace.download = `neon-edge-${Date.now()}.png`;
          enlace.click();
          URL.revokeObjectURL(enlace.href);
        }, "image/png", 0.95);
      } catch (e) {
        // Fallback para iOS Safari
        const enlace = document.createElement("a");
        enlace.download = "neon-edge.png";
        enlace.href = canvas.toDataURL("image/png", 0.95);
        enlace.click();
      }
    });

    actualizarEtiquetas();
  </script>
</body>
</html>
